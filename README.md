Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры. Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:

    маршрутизация запросов к нужному сервису на основе конфигурации,
    возможность проверки аутентификационной информации в запросах,
    обеспечение терминации HTTPS.

Обоснуйте свой выбор.

| Наименование API Gateway	| маршрутизация запросов к нужному сервису на основе конфигурации |	возможность проверки аутентификационной информации в запросах |	обеспечение терминации HTTPS |
|-|-|-|-|
|Azure API Management|+|+|+|
|Amazon API Gateway|+|+|+|
|Yandex API Gateway|+|+|+|
|KrakenD|+|+|+|
|NGINX API Gateway|+|+|+|

>Ответ: предложу KrakenD из-за его высокой скорости работы, возможности трансляции протоколов и способности работы с множеством протоколов.

## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:

    поддержка кластеризации для обеспечения надёжности,
    хранение сообщений на диске в процессе доставки,
    высокая скорость работы,
    поддержка различных форматов сообщений,
    разделение прав доступа к различным потокам сообщений,
    простота эксплуатации.

Обоснуйте свой выбор.

|Наименование|поддержка кластеризации для обеспечения надёжности|хранение сообщений на диске в процессе доставки|высокая скорость работы|поддержка различных форматов сообщений|разделение прав доступа к различным потокам сообщений|простота эксплуатации|
|-|-|-|-|-|-|-|
|Apache Kafka|Да (репликация, ISR)|Да (основной механизм)|Высокая (оптимизирован для throughput)|JSON, Avro, ProtoBuf|Да (ACL, SASL, RBAC)|Сложная|
|RabbitMQ|Да (HA, quorum queues)|Да|Средняя|JSON, XML, AMQP, MQTT|Да (ACL, vhost)|Средняя|
|NATS JetStream|Да (JetStream Clustering)|Да|Высокая (низкая задержка)|JSON, ProtoBuf|Да (account-based security)|Простая|
|ActiveMQ|Да|Да|Средняя|JSON, XML|Да|Средняя|
|Redis Streams|Да (Sentinel, Redis Cluster)|Да|Очень высокая (но без сложной маршрутизации)|JSON, MsgPack, бинарные|Ограниченная (ACL в Redis)|Очень простая (но ограниченные возможности)|

>Ответ: лучшим выбором в большинстве случаев будет RabbitMQ или NATS JetStream, так как они обеспечивают баланс между производительностью, надёжностью и простотой эксплуатации. При этом если важна мощная маршрутизация и гарантированная доставка сообщений то RabbitMQ, а если нужна высокая скорость, лёгкость в развертывании и горизонтальная масштабируемость то NATS JetStream.

## Задача 3: API Gateway * (необязательная)

### Есть три сервиса:

minio

    хранит загруженные файлы в бакете images,
    S3 протокол,

uploader

    принимает файл, если картинка сжимает и загружает его в minio,
    POST /v1/upload,

security

    регистрация пользователя POST /v1/user,
    получение информации о пользователе GET /v1/user,
    логин пользователя POST /v1/token,
    проверка токена GET /v1/token/validation.

### Необходимо воспользоваться любым балансировщиком и сделать API Gateway:

POST /v1/register

    Анонимный доступ.
    Запрос направляется в сервис security POST /v1/user.

POST /v1/token

    Анонимный доступ.
    Запрос направляется в сервис security POST /v1/token.

GET /v1/user

    Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
    Запрос направляется в сервис security GET /v1/user.

POST /v1/upload

    Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
    Запрос направляется в сервис uploader POST /v1/upload.

GET /v1/user/{image}

    Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
    Запрос направляется в сервис minio GET /images/{image}.

### Ожидаемый результат

Результатом выполнения задачи должен быть docker compose файл, запустив который можно локально выполнить следующие команды с успешным результатом. Предполагается, что для реализации API Gateway будет написан конфиг для NGinx или другого балансировщика нагрузки, который будет запущен как сервис через docker-compose и будет обеспечивать балансировку и проверку аутентификации входящих запросов. Авторизация curl -X POST -H 'Content-Type: application/json' -d '{"login":"bob", "password":"qwe123"}' http://localhost/token

Загрузка файла

curl -X POST -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I' -H 'Content-Type: octet/stream' --data-binary @yourfilename.jpg http://localhost/upload

Получение файла curl -X GET http://localhost/images/4e6df220-295e-4231-82bc-45e4b1484430.jpg

>Ответ: [nginx.conf](./gateway/nginx.conf) [docker-compose.yml](./docker-compose.yml)

![docker ps](./task3/docker.png)
![result](./task3/result.png)
